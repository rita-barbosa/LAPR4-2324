@startuml
'https://plantuml.com/sequence-diagram

title US1020 - Sequence Diagram

autonumber

actor "Customer Manager" as USER
participant ":PublishResultJobOpeningUI" as UI <<presentation>>
participant ":PublishResult\nJobOpeningController" as CTRL <<application>>
participant ":AuthorizationService" as AUTHZ <<service>>
database ":RankRepository" as R_REPO <<repository>>
participant ":Rank" as R <<domain>>
participant ":Application" as A <<domain>>
database ":ApplicationRepository" as A_REPO <<repository>>
participant ":ApplicationAcceptedEvent" as NAAE <<domain event>>
participant ":JobOpeningResults\nPublishedEvent" as JORPE <<domain event>>
participant ":EventPublisher" as EP <<interface>>


activate USER

USER -> UI : asks to publish results for job opening
activate UI

UI -> CTRL**: create

UI -> CTRL : getJobOpeningList()
activate CTRL

ref over CTRL

Check **sequence-diagram-job-opening-in-screening**

end ref

CTRL --> UI: jobOpeningListDTO
deactivate CTRL

UI --> USER : displays the job openings and asks to select one
deactivate UI


USER -> UI : selects job opening
activate UI

    UI -> CTRL: publishResultForJobOpening(jobOpeningDto)
    activate CTRL

    CTRL -> AUTHZ:  ensureAuthenticatedUserHasAnyOf(roles)
    activate AUTHZ
    deactivate AUTHZ

    CTRL -> CTRL : publishResults(jobOpeningDto)
    activate CTRL

        CTRL -> R_REPO: rankOfJobOpening(jobReference)
        activate R_REPO
        deactivate R_REPO

        CTRL -> R: publishResults(numVacancies)
        activate R

            loop for each RankOrder

                alt if orderValue <= numVacancies
                    R -> A : acceptApplication()
                    activate A


                    A -> NAAE**: create(candidateEmail, jobReference)
                    A -> EP: publish(applicationAcceptedEvent)
                    activate EP
                    deactivate EP

                    deactivate A

                else
                    R-> A: rejectApplication()<
                    activate A
                    deactivate A
                end alt

                R -> A_REPO: save(application)
                activate A_REPO
                deactivate A_REPO

            end loop
        R --> CTRL: acceptedCandidateList
        deactivate R

    CTRL-> JORPE**: create(acceptedCandidateList, companyCode, jobReference)
    CTRL -> EP: publish(jobOpeningResultsPublishedEvent)
    activate EP
    deactivate EP


    CTRL --> CTRL:
    deactivate CTRL

CTRL --> UI: success
deactivate CTRL

UI --> USER: displays success

deactivate USER


@enduml